<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>스트리머 화면 - 리팩토링 버전</title>

        <!-- STOMP 관련 라이브러리 추가 -->
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f4f4f4;
            }

            #container {
                max-width: 800px;
                margin: auto;
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }

            #messages {
                border: 1px solid #ccc;
                padding: 10px;
                height: 300px;
                overflow-y: scroll;
                margin-bottom: 10px;
                background-color: #e9ecef;
            }

            #participants {
                border: 1px solid #ccc;
                padding: 10px;
                height: 150px;
                overflow-y: scroll;
                margin-top: 20px;
                background-color: #e9ecef;
            }

            input[type="text"] {
                width: calc(100% - 70px);
                padding: 8px;
                margin-right: 5px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }

            button {
                padding: 8px 15px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            button:hover {
                background-color: #0056b3;
            }

            button:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
            }

            h2,
            h3 {
                color: #333;
            }

            .connection-form {
                margin-bottom: 20px;
                padding: 15px;
                background-color: #f8f9fa;
                border-radius: 5px;
            }

            .connection-form input {
                width: 200px;
                margin-right: 10px;
                margin-bottom: 10px;
            }

            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
            }

            .status.connected {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .status.disconnected {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .system-message {
                color: #6c757d;
                font-style: italic;
            }
        </style>
    </head>

    <body>
        <div id="container">
            <h2>스트리머 채팅 화면 - 리팩토링 버전</h2>

            <!-- 연결 설정 폼 -->
            <div class="connection-form">
                <div>
                    <label for="streamKeyInput">스트림 키:</label>
                    <input
                        type="text"
                        id="streamKeyInput"
                        placeholder="예: a1b2c3d4"
                        value="a1b2c3d4"
                    />
                </div>
                <div>
                    <!-- [추가] JWT 토큰 입력란 -->
                    <label for="jwtInput">JWT 토큰:</label>
                    <input
                        type="text"
                        id="jwtInput"
                        placeholder="Bearer eyJhbGci..."
                        value="Bearer streamer-a1b2c3d4-token"
                    />
                </div>
                <button onclick="connectStreamer()" id="connectBtn">
                    채널 시작
                </button>
                <button
                    onclick="disconnectStreamer()"
                    id="disconnectBtn"
                    disabled
                >
                    연결 종료
                </button>
            </div>

            <!-- 연결 상태 표시 -->
            <div id="connectionStatus" class="status disconnected">
                <strong>상태:</strong> 연결 안됨 | <strong>채널:</strong>
                <span id="streamChannel">없음</span>
            </div>

            <hr />

            <!-- 채팅 메시지 영역 -->
            <h3>채팅 메시지</h3>
            <div id="messages"></div>
            <input
                type="text"
                id="messageInput"
                placeholder="메시지 입력..."
                disabled
            />
            <button onclick="sendMessage()" disabled id="sendBtn">전송</button>

            <!-- 참가자 목록 (스트리머 전용 기능) -->
            <h3>채팅방 참가자 목록 <span id="participantCount">(0명)</span></h3>
            <ul id="participants">
                <li>참가자가 없습니다.</li>
            </ul>
        </div>

        <script>
            // 전역 변수 선언
            let stompClient = null;
            let streamKey = "";
            let nickname = "스트리머";

            /**
             * 스트리머 채널 연결 함수
             */
            function connectStreamer() {
                // 1. 입력값 검증
                streamKey = document
                    .getElementById("streamKeyInput")
                    .value.trim();
                const jwtToken = document
                    .getElementById("jwtInput")
                    .value.trim(); // [추가] JWT 토큰 가져오기

                if (!streamKey || !jwtToken) {
                    alert("스트림 키와 JWT 토큰을 모두 입력해주세요.");
                    return;
                }

                // 2. 기존 연결이 있다면 정리
                if (stompClient && stompClient.connected) {
                    stompClient.disconnect();
                }

                // 3. SockJS 소켓 생성
                const socket = new SockJS("http://localhost:8080/ws");

                // 4. STOMP 클라이언트 생성
                stompClient = Stomp.over(socket);
                stompClient.debug = null;

                // [변경] 5. 연결 시 헤더에 JWT 토큰 추가
                const headers = { Authorization: jwtToken };

                // 6. STOMP 서버 연결 시도
                stompClient.connect(
                    headers,
                    function (frame) {
                        console.log("STOMP 연결 성공:", frame);
                        onConnected();
                    },
                    function (error) {
                        console.error("STOMP 연결 실패:", error);
                        onError(error);
                    }
                );
            }

            /**
             * 연결 성공시 처리 함수
             */
            function onConnected() {
                updateConnectionUI(true);
                addMessage(
                    "시스템",
                    `스트리머 채널 ${streamKey}을(를) 시작했습니다.`,
                    true
                );

                // [변경] 새로운 엔드포인트로 구독 시작
                subscribeToChannels();

                // [변경] 스트리머가 채널에 참여했음을 서버에 알림
                sendJoinMessage();
            }

            /**
             * 채널 구독 설정 함수
             */
            function subscribeToChannels() {
                // [변경] 1. 채팅 및 시스템 메시지 채널 구독 (/sub/{streamKey}/chat)
                stompClient.subscribe(
                    `/sub/${streamKey}/chat`,
                    function (message) {
                        const data = JSON.parse(message.body);
                        console.log("채팅 메시지 수신:", data);

                        // [변경] 새로운 DTO 구조에 맞춰 처리
                        if (data.type) {
                            // SystemMessageDto: 시스템 메시지 (입장, 퇴장 알림 등)
                            addMessage("시스템", data.message, true);
                        } else {
                            // ChatMessageDto: 실제 채팅 메시지
                            addMessage(data.nickname, data.message, false);
                        }
                    }
                );

                // [변경] 2. 참가자 목록 업데이트 채널 구독 (/sub/{streamKey}/participants)
                stompClient.subscribe(
                    `/sub/${streamKey}/participants`,
                    function (message) {
                        const data = JSON.parse(message.body);
                        console.log("참가자 목록 수신:", data);

                        // ParticipantListDto: 참가자 목록
                        if (data.participants) {
                            updateParticipants(data.participants);
                        }
                    }
                );

                // [추가] 3. 개인 알림 채널 구독 (강퇴, 채팅금지 등을 위함)
                stompClient.subscribe(
                    "/user/queue/notifications",
                    function (message) {
                        const notification = JSON.parse(message.body);
                        alert(`개인 알림 수신: ${notification.message}`);
                    }
                );
            }

            /**
             * 스트리머 참여 메시지 전송
             */
            function sendJoinMessage() {
                // [변경] 새로운 엔드포인트로 참여 메시지 전송
                stompClient.send(`/pub/stream/${streamKey}/join`, {}, {});
            }

            /**
             * 연결 종료 함수
             */
            function disconnectStreamer() {
                if (stompClient && stompClient.connected) {
                    // 연결 종료 (자동으로 StompDisconnectEvent가 처리함)
                    stompClient.disconnect(function () {
                        updateConnectionUI(false);
                        addMessage(
                            "시스템",
                            "채널 연결이 종료되었습니다.",
                            true
                        );
                        console.log("STOMP 연결 해제됨");

                        // 참가자 목록 초기화
                        document.getElementById("participants").innerHTML =
                            "<li>참가자가 없습니다.</li>";
                        document.getElementById(
                            "participantCount"
                        ).textContent = "(0명)";
                    });
                }
            }

            /**
             * 채팅 메시지 전송 함수
             */
            function sendMessage() {
                const messageInput = document.getElementById("messageInput");
                const message = messageInput.value.trim();

                // 연결 상태 및 메시지 유효성 검증
                if (!stompClient || !stompClient.connected) {
                    alert("채널에 연결되지 않았습니다.");
                    return;
                }

                if (!message) {
                    alert("메시지를 입력해주세요.");
                    return;
                }

                // [변경] ChatMessageDto 형식으로 전송
                const chatMessage = {
                    nickname: nickname,
                    message: message,
                    timestamp: new Date().toISOString(),
                };

                // [변경] 새로운 엔드포인트로 메시지 전송
                stompClient.send(
                    `/pub/stream/${streamKey}/chat`,
                    {},
                    JSON.stringify(chatMessage)
                );

                // 입력창 초기화
                messageInput.value = "";
            }

            /**
             * 연결 오류 처리 함수
             */
            function onError(error) {
                console.error("STOMP 오류:", error);
                updateConnectionUI(false);
                const errorMessage = error.headers
                    ? error.headers.message
                    : error;
                addMessage("시스템", "연결 오류: " + errorMessage, true);
            }

            /**
             * UI 연결 상태 업데이트 함수
             */
            function updateConnectionUI(connected) {
                const statusDiv = document.getElementById("connectionStatus");
                const messageInput = document.getElementById("messageInput");
                const sendBtn = document.getElementById("sendBtn");
                const connectBtn = document.getElementById("connectBtn");
                const disconnectBtn = document.getElementById("disconnectBtn");

                if (connected) {
                    // 연결됨 상태 UI
                    statusDiv.className = "status connected";
                    statusDiv.innerHTML = `<strong>상태:</strong> 연결됨 | <strong>채널:</strong> <span>${streamKey}</span>`;
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                } else {
                    // 연결 안됨 상태 UI
                    statusDiv.className = "status disconnected";
                    statusDiv.innerHTML = `<strong>상태:</strong> 연결 안됨 | <strong>채널:</strong> <span>없음</span>`;
                    messageInput.disabled = true;
                    sendBtn.disabled = true;
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                }
            }

            /**
             * 채팅 메시지 화면에 추가하는 함수
             */
            function addMessage(sender, message, isSystem) {
                const messagesDiv = document.getElementById("messages");
                const messageElement = document.createElement("div");
                const timestamp = new Date().toLocaleTimeString();

                messageElement.innerHTML = `<strong>[${timestamp}] ${sender}:</strong> ${message}`;
                if (isSystem) {
                    messageElement.classList.add("system-message");
                }
                messagesDiv.appendChild(messageElement);

                // 스크롤을 최신 메시지로 이동
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            /**
             * 참가자 목록 업데이트 함수 (스트리머 전용)
             */
            function updateParticipants(participants) {
                const participantsList =
                    document.getElementById("participants");
                const participantCount =
                    document.getElementById("participantCount");

                // 기존 목록 초기화
                participantsList.innerHTML = "";

                if (!participants || participants.length === 0) {
                    // 참가자가 없는 경우
                    const li = document.createElement("li");
                    li.textContent = "참가자가 없습니다.";
                    participantsList.appendChild(li);
                    participantCount.textContent = "(0명)";
                    return;
                }

                // 참가자 목록 생성
                participants.forEach((participant) => {
                    const li = document.createElement("li");
                    li.textContent = `${participant.nickname} (ID: ${participant.userId})`;
                    participantsList.appendChild(li);
                });

                // 참가자 수 업데이트
                participantCount.textContent = `(${participants.length}명)`;
            }

            /**
             * 키보드 이벤트 처리
             */
            document
                .getElementById("messageInput")
                .addEventListener("keypress", function (event) {
                    if (event.key === "Enter") {
                        sendMessage();
                    }
                });

            /**
             * 페이지 종료시 연결 정리
             */
            window.addEventListener("beforeunload", function () {
                if (stompClient && stompClient.connected) {
                    disconnectStreamer();
                }
            });
        </script>
    </body>
</html>
